# Java DAO 层 顾客数据访问代码详解（带注释）

## 代码整体结构说明

这段代码是顾客管理系统的**数据访问层（DAO 层）** 实现，负责直接与数据库交互，执行 CRUD（创建、读取、更新、删除）操作。DAO 层将数据库操作封装起来，为上层 Service 层提供数据访问接口，屏蔽了底层数据库细节。

```java
// 包声明：指定该DAO类所属的包
package com.insurance.dao;

// 导入所需类：
// 1. 模型类：Customer（顾客数据模型）
// 2. 工具类：DatabaseUtil（数据库连接工具）
// 3. JDBC相关类：用于数据库连接和操作
// 4. 集合类：用于存储查询结果
import com.insurance.model.Customer;
import com.insurance.util.DatabaseUtil;
import java.sql.*;
import java.util.ArrayList;
import java.util.List;

/**
 * 顾客数据访问对象（DAO）
 * 负责直接与数据库交互，执行SQL语句，实现数据的CRUD操作
 */
public class CustomerDAO {

    /**
     * 根据ID获取顾客信息
     * @param id 顾客在数据库中的唯一标识
     * @return 顾客对象（包含数据库中的所有字段信息），若不存在则返回null
     */
    public Customer getCustomerById(int id) {
        // SQL查询语句：查询指定ID且未被删除的顾客
        // deleted_flag = 0 表示记录未被删除（软删除机制）
        String sql = "SELECT * FROM customers WHERE id = ? AND deleted_flag = 0";

        // try-with-resources语句：自动管理资源，无需手动关闭Connection、PreparedStatement
        try (
            // 获取数据库连接
            Connection conn = DatabaseUtil.getConnection();
            // 创建PreparedStatement对象，用于执行带参数的SQL
            PreparedStatement pstmt = conn.prepareStatement(sql)
        ) {
            // 设置SQL参数：第一个问号(?)的值为id
            pstmt.setInt(1, id);

            // 执行查询，返回结果集
            ResultSet rs = pstmt.executeQuery();

            // 判断结果集是否有数据
            if (rs.next()) {
                // 将结果集映射为Customer对象并返回
                return mapResultSetToCustomer(rs);
            }
        } catch (SQLException e) {
            // 处理SQL异常（打印异常信息）
            e.printStackTrace();
        }
        // 若未找到记录或发生异常，返回null
        return null;
    }

    /**
     * 根据顾客编号获取顾客信息
     * @param customerCode 业务系统中的顾客唯一编号（非数据库ID）
     * @return 顾客对象，若不存在则返回null
     */
    public Customer getCustomerByCode(String customerCode) {
        // SQL查询语句：根据顾客编号查询未删除的顾客
        String sql = "SELECT * FROM customers WHERE customer_code = ? AND deleted_flag = 0";

        try (
            Connection conn = DatabaseUtil.getConnection();
            PreparedStatement pstmt = conn.prepareStatement(sql)
        ) {
            // 设置参数：顾客编号
            pstmt.setString(1, customerCode);

            ResultSet rs = pstmt.executeQuery();
            if (rs.next()) {
                return mapResultSetToCustomer(rs);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }

    /**
     * 获取所有顾客列表
     * @return 包含所有未删除顾客的List集合
     */
    public List<Customer> getAllCustomers() {
        // 创建ArrayList存储顾客对象
        List<Customer> customers = new ArrayList<>();

        // SQL查询语句：查询所有未删除的顾客，按创建时间降序排列
        String sql = "SELECT * FROM customers WHERE deleted_flag = 0 ORDER BY created_at DESC";

        try (
            Connection conn = DatabaseUtil.getConnection();
            // 创建Statement对象（无参数SQL）
            Statement stmt = conn.createStatement();
            // 执行查询
            ResultSet rs = stmt.executeQuery(sql)
        ) {
            // 遍历结果集
            while (rs.next()) {
                // 将每条记录映射为Customer对象并添加到集合
                customers.add(mapResultSetToCustomer(rs));
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return customers;
    }

    /**
     * 添加新顾客
     * @param customer 包含顾客信息的对象
     * @return true表示添加成功，false表示添加失败
     */
    public boolean addCustomer(Customer customer) {
        // SQL插入语句：向customers表插入新记录
        // 字段列表：指定要插入的字段
        // VALUES：对应字段的值，使用?作为占位符
        String sql = "INSERT INTO customers (customer_code, first_name, last_name, first_name_kana, last_name_kana, " +
                     "gender, birth_date, age, postal_code, prefecture, city, address_line1, address_line2, " +
                     "phone_number, email, occupation, annual_income, family_composition) " +
                     "VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";

        try (
            Connection conn = DatabaseUtil.getConnection();
            PreparedStatement pstmt = conn.prepareStatement(sql)
        ) {
            // 设置SQL参数（按顺序对应VALUES中的?）
            pstmt.setString(1, customer.getCustomerCode());       // 顾客编号
            pstmt.setString(2, customer.getFirstName());          // 名
            pstmt.setString(3, customer.getLastName());           // 姓
            pstmt.setString(4, customer.getFirstNameKana());      // 名（假名）
            pstmt.setString(5, customer.getLastNameKana());       // 姓（假名）
            pstmt.setString(6, customer.getGender());             // 性别
            // 将java.util.Date转换为java.sql.Date
            pstmt.setDate(7, new java.sql.Date(customer.getBirthDate().getTime())); // 出生日期
            pstmt.setInt(8, customer.getAge());                   // 年龄
            pstmt.setString(9, customer.getPostalCode());         // 邮政编码
            pstmt.setString(10, customer.getPrefecture());        // 都道府县
            pstmt.setString(11, customer.getCity());              // 市町村
            pstmt.setString(12, customer.getAddressLine1());      // 地址1
            pstmt.setString(13, customer.getAddressLine2());      // 地址2
            pstmt.setString(14, customer.getPhoneNumber());       // 电话号码
            pstmt.setString(15, customer.getEmail());             // 邮箱
            pstmt.setString(16, customer.getOccupation());        // 职业
            pstmt.setDouble(17, customer.getAnnualIncome());      // 年收入
            pstmt.setString(18, customer.getFamilyComposition()); // 家庭构成

            // 执行更新操作，返回受影响的行数
            int rowsAffected = pstmt.executeUpdate();

            // 如果受影响行数大于0，表示添加成功
            return rowsAffected > 0;
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

    /**
     * 更新顾客信息
     * @param customer 包含更新信息的顾客对象（必须包含ID）
     * @return true表示更新成功，false表示更新失败
     */
    public boolean updateCustomer(Customer customer) {
        // SQL更新语句：更新指定ID且未删除的顾客信息
        String sql = "UPDATE customers SET first_name = ?, last_name = ?, first_name_kana = ?, last_name_kana = ?, " +
                     "gender = ?, birth_date = ?, age = ?, postal_code = ?, prefecture = ?, city = ?, " +
                     "address_line1 = ?, address_line2 = ?, phone_number = ?, email = ?, occupation = ?, " +
                     "annual_income = ?, family_composition = ?, updated_at = CURRENT_TIMESTAMP " +
                     "WHERE id = ? AND deleted_flag = 0";

        try (
            Connection conn = DatabaseUtil.getConnection();
            PreparedStatement pstmt = conn.prepareStatement(sql)
        ) {
            // 设置更新字段的值（按顺序对应SET子句中的?）
            pstmt.setString(1, customer.getFirstName());
            pstmt.setString(2, customer.getLastName());
            pstmt.setString(3, customer.getFirstNameKana());
            pstmt.setString(4, customer.getLastNameKana());
            pstmt.setString(5, customer.getGender());
            pstmt.setDate(6, new java.sql.Date(customer.getBirthDate().getTime()));
            pstmt.setInt(7, customer.getAge());
            pstmt.setString(8, customer.getPostalCode());
            pstmt.setString(9, customer.getPrefecture());
            pstmt.setString(10, customer.getCity());
            pstmt.setString(11, customer.getAddressLine1());
            pstmt.setString(12, customer.getAddressLine2());
            pstmt.setString(13, customer.getPhoneNumber());
            pstmt.setString(14, customer.getEmail());
            pstmt.setString(15, customer.getOccupation());
            pstmt.setDouble(16, customer.getAnnualIncome());
            pstmt.setString(17, customer.getFamilyComposition());
            // WHERE条件：更新指定ID的记录
            pstmt.setInt(18, customer.getId());

            // 执行更新，返回受影响的行数
            int rowsAffected = pstmt.executeUpdate();
            return rowsAffected > 0;
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

    /**
     * 软删除顾客（逻辑删除）
     * 不是真正删除记录，而是将deleted_flag设为1
     * @param id 顾客ID
     * @return true表示删除成功，false表示删除失败
     */
    public boolean deleteCustomer(int id) {
        // SQL更新语句：设置deleted_flag=1（表示已删除），更新更新时间
        String sql = "UPDATE customers SET deleted_flag = 1, updated_at = CURRENT_TIMESTAMP WHERE id = ?";

        try (
            Connection conn = DatabaseUtil.getConnection();
            PreparedStatement pstmt = conn.prepareStatement(sql)
        ) {
            pstmt.setInt(1, id);

            int rowsAffected = pstmt.executeUpdate();
            return rowsAffected > 0;
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

    /**
     * 搜索顾客
     * @param keyword 搜索关键词（匹配姓名、邮箱、电话等字段）
     * @return 符合条件的顾客列表
     */
    public List<Customer> searchCustomers(String keyword) {
        List<Customer> customers = new ArrayList<>();

        // SQL查询语句：多字段模糊搜索未删除的顾客
        String sql = "SELECT * FROM customers WHERE deleted_flag = 0 AND " +
                     "(first_name LIKE ? OR last_name LIKE ? OR customer_code LIKE ? OR email LIKE ? OR phone_number LIKE ?) " +
                     "ORDER BY created_at DESC";

        try (
            Connection conn = DatabaseUtil.getConnection();
            PreparedStatement pstmt = conn.prepareStatement(sql)
        ) {
            // 构建模糊搜索模式（%表示任意字符）
            String searchPattern = "%" + keyword + "%";

            // 为所有?设置相同的搜索模式（匹配不同字段）
            for (int i = 1; i <= 5; i++) {
                pstmt.setString(i, searchPattern);
            }

            ResultSet rs = pstmt.executeQuery();

            // 遍历结果集，将每条记录映射为Customer对象并添加到列表
            while (rs.next()) {
                customers.add(mapResultSetToCustomer(rs));
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return customers;
    }

    /**
     * 辅助方法：将ResultSet映射为Customer对象
     * 从结果集中提取字段值，设置到Customer对象的属性中
     * @param rs 数据库查询结果集
     * @return 映射后的Customer对象
     * @throws SQLException 若获取字段值时发生错误
     */
    private Customer mapResultSetToCustomer(ResultSet rs) throws SQLException {
        // 创建Customer对象
        Customer customer = new Customer();

        // 设置属性值（从结果集获取对应字段的值）
        customer.setId(rs.getInt("id"));
        customer.setCustomerCode(rs.getString("customer_code"));
        customer.setFirstName(rs.getString("first_name"));
        customer.setLastName(rs.getString("last_name"));
        customer.setFirstNameKana(rs.getString("first_name_kana"));
        customer.setLastNameKana(rs.getString("last_name_kana"));
        customer.setGender(rs.getString("gender"));
        customer.setBirthDate(rs.getDate("birth_date"));
        customer.setAge(rs.getInt("age"));
        customer.setPostalCode(rs.getString("postal_code"));
        customer.setPrefecture(rs.getString("prefecture"));
        customer.setCity(rs.getString("city"));
        customer.setAddressLine1(rs.getString("address_line1"));
        customer.setAddressLine2(rs.getString("address_line2"));
        customer.setPhoneNumber(rs.getString("phone_number"));
        customer.setEmail(rs.getString("email"));
        customer.setOccupation(rs.getString("occupation"));
        customer.setAnnualIncome(rs.getDouble("annual_income"));
        customer.setFamilyComposition(rs.getString("family_composition"));
        customer.setCreatedAt(rs.getTimestamp("created_at"));
        customer.setUpdatedAt(rs.getTimestamp("updated_at"));
        customer.setDeletedFlag(rs.getBoolean("deleted_flag"));

        return customer;
    }
}
```

## 核心知识点总结

### 1. 数据访问层（DAO 层）的作用

- **数据库交互**：直接与数据库通信，执行 SQL 语句
- **数据封装**：将数据库操作封装为方法，提供给 Service 层调用
- **隔离性**：屏蔽数据库实现细节，Service 层无需了解 SQL 和数据库连接
- **安全性**：使用 PreparedStatement 防止 SQL 注入攻击

### 2. JDBC 编程基础

- **核心组件**：
  - `Connection`：数据库连接
  - `PreparedStatement`：执行带参数的 SQL 语句
  - `ResultSet`：查询结果集
  - `SQLException`：处理数据库操作异常
- **操作流程**：
  1. 获取数据库连接
  2. 创建 PreparedStatement 对象
  3. 设置 SQL 参数
  4. 执行 SQL（查询/更新）
  5. 处理结果（ResultSet 映射）
  6. 关闭资源（自动或手动）

### 3. PreparedStatement 的优势

- **防止 SQL 注入**：参数化查询，将数据与 SQL 语句分离
- **性能优化**：预编译 SQL，重复执行时效率更高
- **类型安全**：提供类型化的参数设置方法（setInt、setString 等）

### 4. 结果集映射（ORM 基础）

- **手动映射**：通过`mapResultSetToCustomer`方法将 ResultSet 转换为 Java 对象
- **映射规则**：数据库字段名与 Java 对象属性名对应
- **意义**：将关系型数据转换为面向对象数据，便于上层处理

### 5. 软删除机制

- **概念**：不真正删除数据库记录，而是通过`deleted_flag`标记记录状态
- **实现**：所有查询和更新操作都添加`deleted_flag = 0`条件
- **优势**：保留历史数据，便于数据恢复，不破坏数据关联

### 6. try-with-resources 语句

- **自动资源管理**：无需手动调用 close()方法关闭资源
- **语法**：`try (资源声明) { ... }`
- **适用对象**：实现`AutoCloseable`接口的类（如 Connection、PreparedStatement）

### 7. SQL 语句解析

- **SELECT**：查询数据，带 WHERE 条件过滤结果
- **INSERT**：插入新记录，使用 VALUES 设置字段值
- **UPDATE**：更新记录，使用 WHERE 指定更新条件
- **LIKE**：模糊查询，`%`匹配任意字符
- **ORDER BY**：排序查询结果

### 8. 异常处理

- **SQLException**：数据库操作可能抛出的异常
- **处理方式**：打印异常堆栈信息，便于调试
- **改进方向**：实际项目中可添加日志记录或事务回滚

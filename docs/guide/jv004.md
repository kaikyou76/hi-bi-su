# Java Service 层 顾客业务逻辑代码详解（带注释）

## 代码整体结构说明

这段代码是顾客管理系统的**业务逻辑层（Service 层）** 实现，主要负责：

- 实现核心业务规则和数据验证
- 协调数据访问层（DAO 层）与控制器层（Servlet）的交互
- 处理业务逻辑异常和数据校验

在 MVC 架构中，Service 层扮演着"业务逻辑处理器"的角色，隔离了控制器和数据访问，是实现业务规则的核心场所。

```java
// 包声明：指定该Service类所属的业务逻辑层包
package com.insurance.service;

// 导入所需类：
// 1. DAO层：CustomerDAO（数据访问对象，负责与数据库交互）
// 2. 模型类：Customer（顾客数据模型）
// 3. 集合类：List（用于存储顾客列表）
import com.insurance.dao.CustomerDAO;
import com.insurance.model.Customer;
import java.util.List;

/**
 * 顾客业务逻辑服务类
 * 负责处理所有与顾客相关的业务规则、数据验证和业务流程
 */
public class CustomerService {
    // 声明CustomerDAO对象，用于与数据访问层交互
    private CustomerDAO customerDAO;

    /**
     * 构造方法：初始化CustomerService
     * 在创建Service对象时，同时创建DAO对象，建立与数据层的连接
     */
    public CustomerService() {
        // 实例化CustomerDAO，Service层通过DAO层访问数据库
        this.customerDAO = new CustomerDAO();
    }

    /**
     * 根据ID查询顾客
     * @param id 顾客唯一标识符
     * @return 找到的顾客对象，若不存在则返回null
     */
    public Customer getCustomerById(int id) {
        // 直接调用DAO层方法获取数据，不包含额外业务逻辑
        return customerDAO.getCustomerById(id);
    }

    /**
     * 根据顾客编号查询顾客
     * @param customerCode 顾客唯一编号（业务编号，非数据库ID）
     * @return 找到的顾客对象，若不存在则返回null
     */
    public Customer getCustomerByCode(String customerCode) {
        return customerDAO.getCustomerByCode(customerCode);
    }

    /**
     * 获取所有顾客列表
     * @return 包含所有顾客的List集合
     */
    public List<Customer> getAllCustomers() {
        return customerDAO.getAllCustomers();
    }

    /**
     * 添加新顾客
     * 包含完整的业务逻辑验证：必填字段检查、编号唯一性检查等
     * @param customer 待添加的顾客对象
     * @return true表示添加成功，false表示添加失败（验证未通过或数据库操作失败）
     */
    public boolean addCustomer(Customer customer) {
        // 业务逻辑验证：检查必填字段
        // 1. 检查顾客对象是否为空，或顾客编号是否为空/空白
        if (customer == null || customer.getCustomerCode() == null || customer.getCustomerCode().trim().isEmpty()) {
            return false;
        }
        // 2. 检查名字是否为空
        if (customer.getFirstName() == null || customer.getFirstName().trim().isEmpty()) {
            return false;
        }
        // 3. 检查姓氏是否为空
        if (customer.getLastName() == null || customer.getLastName().trim().isEmpty()) {
            return false;
        }
        // 4. 检查出生日期是否为空
        if (customer.getBirthDate() == null) {
            return false;
        }

        // 业务规则：检查顾客编号是否已存在（避免重复添加）
        Customer existingCustomer = customerDAO.getCustomerByCode(customer.getCustomerCode());
        if (existingCustomer != null) {
            return false; // 编号已存在，返回添加失败
        }

        // 所有验证通过，调用DAO层执行添加操作
        return customerDAO.addCustomer(customer);
    }

    /**
     * 更新顾客信息
     * 包含业务验证：检查顾客是否存在、ID是否有效等
     * @param customer 包含更新信息的顾客对象（必须包含ID）
     * @return true表示更新成功，false表示更新失败
     */
    public boolean updateCustomer(Customer customer) {
        // 验证1：检查顾客对象是否为空或ID是否无效（<=0）
        if (customer == null || customer.getId() <= 0) {
            return false;
        }

        // 验证2：检查顾客是否存在（避免更新不存在的记录）
        Customer existingCustomer = customerDAO.getCustomerById(customer.getId());
        if (existingCustomer == null) {
            return false; // 顾客不存在，更新失败
        }

        // 所有验证通过，调用DAO层执行更新操作
        return customerDAO.updateCustomer(customer);
    }

    /**
     * 删除顾客
     * 包含业务验证：检查ID有效性和顾客存在性
     * @param id 要删除的顾客ID
     * @return true表示删除成功，false表示删除失败
     */
    public boolean deleteCustomer(int id) {
        // 验证1：检查ID是否有效
        if (id <= 0) {
            return false;
        }

        // 验证2：检查顾客是否存在
        Customer existingCustomer = customerDAO.getCustomerById(id);
        if (existingCustomer == null) {
            return false; // 顾客不存在，删除失败
        }

        // 调用DAO层执行删除操作
        return customerDAO.deleteCustomer(id);
    }

    /**
     * 搜索顾客
     * 支持按关键词搜索，若关键词为空则返回所有顾客
     * @param keyword 搜索关键词（可匹配姓名、邮箱等字段）
     * @return 符合条件的顾客列表
     */
    public List<Customer> searchCustomers(String keyword) {
        // 业务逻辑：若关键词为空或空白，则返回所有顾客
        if (keyword == null || keyword.trim().isEmpty()) {
            return customerDAO.getAllCustomers();
        }
        // 调用DAO层执行搜索，去除关键词前后空格
        return customerDAO.searchCustomers(keyword.trim());
    }

    /**
     * 验证顾客信息合法性
     * 比addCustomer方法更全面的验证，返回具体错误信息
     * @param customer 待验证的顾客对象
     * @return null表示验证通过，否则返回具体错误信息
     */
    public String validateCustomer(Customer customer) {
        // 1. 验证顾客编号
        if (customer.getCustomerCode() == null || customer.getCustomerCode().trim().isEmpty()) {
            return "顾客编号不能为空";
        }

        // 2. 验证名字
        if (customer.getFirstName() == null || customer.getFirstName().trim().isEmpty()) {
            return "名不能为空";
        }

        // 3. 验证姓氏
        if (customer.getLastName() == null || customer.getLastName().trim().isEmpty()) {
            return "姓不能为空";
        }

        // 4. 验证性别（必须为"M"或"F"）
        if (customer.getGender() == null || (!customer.getGender().equals("M") && !customer.getGender().equals("F"))) {
            return "性别必须为M或F";
        }

        // 5. 验证出生日期
        if (customer.getBirthDate() == null) {
            return "出生日期不能为空";
        }

        // 6. 验证邮箱格式（如果提供了邮箱）
        if (customer.getEmail() != null && !customer.getEmail().trim().isEmpty()) {
            if (!isValidEmail(customer.getEmail())) {
                return "邮箱格式不正确";
            }
        }

        // 7. 验证电话号码格式（如果提供了电话）
        if (customer.getPhoneNumber() != null && !customer.getPhoneNumber().trim().isEmpty()) {
            if (!isValidPhoneNumber(customer.getPhoneNumber())) {
                return "电话号码格式不正确";
            }
        }

        // 所有验证通过，返回null
        return null;
    }

    /**
     * 验证邮箱格式（辅助方法）
     * 使用正则表达式检查邮箱格式是否合法
     * @param email 待验证的邮箱地址
     * @return true表示格式正确，false表示格式错误
     */
    private boolean isValidEmail(String email) {
        // 正则表达式：^[A-Za-z0-9+_.-]+@(.+)$
        // 解释：
        // ^ 开头
        // [A-Za-z0-9+_.-]+ 允许字母、数字、+、_、.、- 字符
        // @ 必须包含@符号
        // (.+) @后面必须有内容（域名部分）
        // $ 结尾
        return email.matches("^[A-Za-z0-9+_.-]+@(.+)$");
    }

    /**
     * 验证电话号码格式（辅助方法）
     * 允许数字、-、(、)和空格
     * @param phoneNumber 待验证的电话号码
     * @return true表示格式正确，false表示格式错误
     */
    private boolean isValidPhoneNumber(String phoneNumber) {
        // 正则表达式：^[0-9\\-\\(\\)\\s]+$
        // 解释：只允许数字、-、(、)和空格
        return phoneNumber.matches("^[0-9\\-\\(\\)\\s]+$");
    }
}
```

## 核心知识点总结

### 1. 业务逻辑层（Service 层）的作用

- **承上启下**：连接控制器（Servlet）和数据访问层（DAO）
- **业务规则实现**：封装业务逻辑，如数据验证、权限检查、事务处理
- **数据一致性**：确保数据符合业务规则后才传递给 DAO 层
- **代码复用**：不同的控制器可以调用同一个 Service 方法，避免代码重复

### 2. 与 DAO 层的交互

- **依赖关系**：Service 层依赖 DAO 层完成数据操作
- **解耦设计**：控制器不直接访问 DAO，而是通过 Service 层间接访问
- **调用流程**：控制器 → Service（业务逻辑） → DAO（数据操作） → 数据库

### 3. 业务逻辑验证

- **必要性**：防止无效数据进入系统，保证数据质量
- **验证时机**：在数据到达 DAO 层之前进行验证
- **验证内容**：
  - 必填字段检查（如顾客编号、姓名不能为空）
  - 数据格式验证（如邮箱、电话号码格式）
  - 业务规则检查（如顾客编号唯一性）
  - 数据有效性检查（如 ID 必须大于 0）

### 4. 方法命名规范

- **动词+名词**：如 addCustomer、updateCustomer、deleteCustomer
- **清晰表达意图**：方法名直接反映其功能，提高代码可读性

### 5. 正则表达式在数据验证中的应用

- **邮箱验证**：`^[A-Za-z0-9+_.-]+@(.+)$`
  - 允许字母、数字、+、\_、.、- 作为用户名
  - 必须包含@符号和域名部分
- **电话号码验证**：`^[0-9\\-\\(\\)\\s]+$`
  - 只允许数字、-、(、)和空格，适应不同格式的电话号码

### 6. 返回值设计

- **boolean 类型**：用于添加、更新、删除操作，表示操作成功与否
- **String 类型**：validateCustomer 方法返回错误信息（null 表示成功）
- **集合类型**：查询多个结果时返回 List 集合
- **对象类型**：查询单个结果时返回实体对象（如 Customer）

### 7. 分层架构的优势

- **关注点分离**：每层只负责自己的职责（Servlet 处理请求，Service 处理业务，DAO 处理数据）
- **便于维护**：修改业务逻辑只需改动 Service 层，不影响控制器和 DAO
- **可测试性**：可以单独测试 Service 层的业务逻辑
- **代码清晰**：结构分明，新手更容易理解整体架构

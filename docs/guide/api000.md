# API 文件的工作原理

## 基础架构

1. 客户端请求 → Web 服务器 → Servlet 容器 → API Servlet → 业务服务层 → 数据访问层 → 数据库

### 以 CustomerApiServlet 为例说明工作流程：

1. 请求接收：当客户端访问`/api/customers/*`路径时，Web 服务器将请求路由到 CustomerApiServlet
2. 权限验证：在`handleRequest`方法中首先检查用户权限
3. 路径解析：根据 URL 路径决定执行哪个操作
4. 业务处理：调用 CustomerService 处理具体业务逻辑
5. 响应返回：通过 ApiResponse 格式化 JSON 响应返回给客户端

## 2. 调用时机和步骤

### 启动阶段

1. 应用启动时：
   - Web 服务器读取`@WebServlet`注解，注册 Servlet
   - 调用`init()`方法初始化服务对象

### 运行时调用

2. 客户端发起请求时：
   - 客户端发送 HTTP 请求（如`GET /api/customers/123`）
   - Web 服务器将请求分发给对应的 Servlet
   - 调用`handleRequest`方法处理请求

### 具体调用链

1. `handleRequest()` → 根据路径和方法 → 具体处理方法 → 服务层 → DAO 层 → 数据库

## 3. 各 API 文件的职责

| API 文件                  | 路径                      | 负责的业务           |
| ------------------------- | ------------------------- | -------------------- |
| CustomerApiServlet        | /api/customers/\*         | 客户管理（增删改查） |
| ContractApiServlet        | /api/contracts/\*         | 保险契约管理         |
| DocumentRequestApiServlet | /api/document-requests/\* | 资料请求管理         |
| PremiumApiServlet         | /api/premium/\*           | 保险费率计算         |
| UserManagementController  | /admin/users/\*           | 用户管理             |

## 4. 实际调用示例

当用户在前端执行以下操作时：

1. 查看客户列表：

   - 前端请求：`GET /api/customers/`
   - 调用：`CustomerApiServlet.handleRequest() → getCustomers()`

2. 创建新客户：

   - 前端请求：`POST /api/customers/`
   - 调用：`CustomerApiServlet.handleRequest() → createCustomer()`

3. 计算保险费：
   - 前端请求：`POST /api/premium/calculate`
   - 调用：`PremiumApiServlet.handleRequest() → calculatePremium()`

## 5. 调用关系图

1. 前端应用
2. ↓ (HTTP 请求)
3. Web 服务器/Tomcat
4. ↓ (Servlet 映射)
5. API Servlets
6. ↓ (调用服务层)
7. Service 层 (业务逻辑)
8. ↓ (调用数据访问)
9. DAO 层 (数据库操作)
10. ↓
11. 数据库

## 6. 关键调用点

1. 权限检查：每个 API 的`requiresPermission()`和`hasPermission()`方法
2. 路径路由：`handleRequest()`方法中的 pathInfo 判断
3. 业务处理：各具体处理方法（如`getCustomers`, `createCustomer`等）
4. 数据访问：通过 Service 层调用 DAO 层访问数据库
5. 响应构建：使用`ApiResponse`构建统一的 JSON 响应

**这样设计的好处是职责分离，便于维护和扩展**。每个 API Servlet 只负责 HTTP 请求的接收和响应，具体业务逻辑由 Service 层处理。

# 用户认证流程

本文档详细描述了从用户登录到权限验证的完整认证流程，包括涉及的类文件和方法。

## 1. 流程概述

```
用户请求登录 → 认证控制器 → 安全过滤器 → 认证工具类 → 用户服务层 → 用户DAO层 → 数据库 →
用户服务层 → 认证工具类 → 安全过滤器 → 认证控制器 → 登录成功 → 权限验证 → 访问资源
```

## 2. 详细流程分析

### 2.1 用户登录请求阶段

用户访问 URL：`http://localhost:8080/login.jsp`
方法：HTTP GET
参数：无

### 2.2 认证控制器 (AuthController)

**文件**: `src/main/java/com/insurance/controller/AuthController.java`

**关键方法**:

- `doGet()` - 显示登录页面
- `doPost()` - 处理登录表单提交
- `getRedirectUrl()` - 根据角色获取重定向 URL

**核心代码**:

```java
@WebServlet("/login")
public class AuthController extends HttpServlet {

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        // 如果已登录，重定向到主页
        if (AuthUtil.isLoggedIn(request)) {
            response.sendRedirect(request.getContextPath() + "/mypage/dashboard");
            return;
        }

        // 生成CSRF令牌
        String csrfToken = SecurityFilter.generateCSRFToken(request);
        request.setAttribute("csrfToken", csrfToken);

        // 转发到登录页面
        request.getRequestDispatcher("/login.jsp").forward(request, response);
    }

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        request.setCharacterEncoding("UTF-8");

        // 获取表单参数
        String username = request.getParameter("username");
        String password = request.getParameter("password");
        String csrfToken = request.getParameter("csrfToken");

        // 验证CSRF令牌
        String sessionToken = SecurityFilter.getCSRFToken(request);
        if (sessionToken == null || !sessionToken.equals(csrfToken)) {
            request.setAttribute("error", "CSRF令牌验证失败");
            request.getRequestDispatcher("/login.jsp").forward(request, response);
            return;
        }

        // 验证输入参数
        if (username == null || username.trim().isEmpty() ||
            password == null || password.trim().isEmpty()) {
            request.setAttribute("error", "用户名和密码不能为空");
            request.getRequestDispatcher("/login.jsp").forward(request, response);
            return;
        }

        // 认证用户
        boolean authenticated = AuthUtil.authenticate(username, password, request);

        if (authenticated) {
            // 登录成功，根据用户角色重定向到相应页面
            String userRole = (String) request.getSession().getAttribute("userRole");
            String redirectUrl = getRedirectUrl(userRole);
            response.sendRedirect(request.getContextPath() + redirectUrl);
        } else {
            // 登录失败
            request.setAttribute("error", "用户名或密码错误");
            request.setAttribute("username", username);

            // 重新生成CSRF令牌
            String newCsrfToken = SecurityFilter.generateCSRFToken(request);
            request.setAttribute("csrfToken", newCsrfToken);

            // 转发回登录页面
            request.getRequestDispatcher("/login.jsp").forward(request, response);
        }
    }

    private String getRedirectUrl(String role) {
        switch (role) {
            case "ADMIN":
                return "/admin/dashboard";
            case "SALES":
                return "/customer/list";
            case "REVIEWER":
                return "/contract/review";
            case "USER":
                return "/mypage/dashboard";
            default:
                return "/mypage/dashboard";
        }
    }
}
```

### 2.3 安全过滤器 (SecurityFilter)

**文件**: `src/main/java/com/insurance/security/SecurityFilter.java`

**关键方法**:

- `doFilter()` - 执行过滤逻辑
- `checkPermission()` - 检查权限
- `checkCSRFToken()` - 检查 CSRF 令牌
- `preventSessionFixation()` - 防止会话固定攻击

**核心代码**:

```java
@WebFilter(urlPatterns = {"/*"})
public class SecurityFilter implements Filter {
    private static final List<String> PUBLIC_PATHS = Arrays.asList(
        "/login.jsp", "/login", "/logout", "/css/", "/js/", "/images/", "/favicon.ico"
    );

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {

        HttpServletRequest httpRequest = (HttpServletRequest) request;
        HttpServletResponse httpResponse = (HttpServletResponse) response;

        // 设置安全响应头
        setSecurityHeaders(httpResponse);

        // 获取请求路径
        String path = httpRequest.getRequestURI().substring(httpRequest.getContextPath().length());

        // 检查是否为公共路径，如果是则直接放行
        if (isPublicPath(path)) {
            chain.doFilter(request, response);
            return;
        }

        // 检查用户是否已登录，未登录则重定向到登录页面
        if (!AuthUtil.isLoggedIn(httpRequest)) {
            httpResponse.sendRedirect(httpRequest.getContextPath() + "/login.jsp");
            return;
        }

        // 检查会话是否超时
        if (AuthUtil.isSessionTimeout(httpRequest)) {
            AuthUtil.logout(httpRequest);
            httpResponse.sendRedirect(httpRequest.getContextPath() + "/login.jsp?timeout=true");
            return;
        }

        // 更新会话活动时间
        AuthUtil.updateSessionActivity(httpRequest);

        // 检查用户权限
        if (!checkPermission(httpRequest, path)) {
            httpResponse.sendError(HttpServletResponse.SC_FORBIDDEN, "权限不足");
            return;
        }

        // 检查CSRF令牌
        if (!checkCSRFToken(httpRequest, httpResponse)) {
            httpResponse.sendError(HttpServletResponse.SC_FORBIDDEN, "CSRF令牌验证失败");
            return;
        }

        // 防止会话固定攻击
        preventSessionFixation(httpRequest);

        // 所有安全检查通过，继续处理请求
        chain.doFilter(request, response);
    }

    private boolean checkPermission(HttpServletRequest request, String path) {
        // 管理员权限检查
        if (isAdminPath(path) && !AuthUtil.hasPermission(request, "ADMIN")) {
            return false;
        }

        // 销售员权限检查
        if (isSalesPath(path) && !AuthUtil.hasPermission(request, "SALES")) {
            return false;
        }

        // 审查员权限检查
        if (isReviewerPath(path) && !AuthUtil.hasPermission(request, "REVIEWER")) {
            return false;
        }

        return true;
    }

    private boolean checkCSRFToken(HttpServletRequest request, HttpServletResponse response) {
        String method = request.getMethod();

        // 只对POST、PUT、DELETE方法检查CSRF令牌
        if (!"POST".equals(method) && !"PUT".equals(method) && !"DELETE".equals(method)) {
            return true;
        }

        String sessionToken = (String) request.getSession().getAttribute("csrfToken");
        String requestToken = request.getParameter("csrfToken");

        return sessionToken != null && requestToken != null && sessionToken.equals(requestToken);
    }
}
```

### 2.4 认证工具类 (AuthUtil)

**文件**: `src/main/java/com/insurance/security/AuthUtil.java`

**关键方法**:

- `authenticate()` - 用户登录验证
- `encryptPassword()` - 密码加密
- `isLoggedIn()` - 检查用户是否已登录
- `hasPermission()` - 检查用户权限
- `hasModuleAccess()` - 检查模块访问权限

**核心代码**:

```java
public class AuthUtil {
    private static final UserService userService = new UserService();

    public static boolean authenticate(String username, String password, HttpServletRequest request) {
        try {
            // 根据用户名获取用户信息
            User user = userService.getUserByUsername(username);
            // 验证用户是否存在、账户是否激活以及密码是否正确
            if (user != null && user.isActive() &&
                user.getPassword().equals(encryptPassword(password))) {

                // 创建会话并存储用户信息
                HttpSession session = request.getSession(true);
                session.setAttribute("user", user);
                session.setAttribute("loginTime", new Date());
                session.setAttribute("userRole", user.getRole());

                return true;
            }

            return false;
        } catch (Exception e) {
            return false;
        }
    }

    public static String encryptPassword(String password) {
        try {
            MessageDigest md = MessageDigest.getInstance("SHA-256");
            byte[] hashedBytes = md.digest(password.getBytes());
            StringBuilder sb = new StringBuilder();
            for (byte b : hashedBytes) {
                sb.append(String.format("%02x", b));
            }
            return sb.toString();
        } catch (NoSuchAlgorithmException e) {
            throw new RuntimeException("密码加密失败", e);
        }
    }

    public static boolean isLoggedIn(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        return session != null && session.getAttribute("user") != null;
    }

    public static boolean hasPermission(HttpServletRequest request, String requiredRole) {
        User user = getCurrentUser(request);
        if (user == null) {
            return false;
        }

        // 管理员拥有所有权限
        if ("ADMIN".equals(user.getRole())) {
            return true;
        }

        // 检查用户角色是否与所需角色匹配
        return requiredRole.equals(user.getRole());
    }

    public static boolean isSessionTimeout(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session == null) {
            return true;
        }

        Date loginTime = (Date) session.getAttribute("loginTime");
        if (loginTime == null) {
            return true;
        }

        long timeout = 30 * 60 * 1000; // 30分钟
        return (System.currentTimeMillis() - loginTime.getTime()) > timeout;
    }
}
```

### 2.5 用户服务层 (UserService)

**文件**: `src/main/java/com/insurance/service/UserService.java`

**关键方法**:

- `getUserByUsername()` - 根据用户名获取用户
- `getUserById()` - 根据 ID 获取用户

**核心代码**:

```java
public class UserService {
    private UserDAO userDAO;

    public User getUserByUsername(String username) {
        try {
            return userDAO.getUserByUsername(username);
        } catch (Exception e) {
            return null;
        }
    }

    public User getUserById(int id) {
        try {
            return userDAO.getUserById(id);
        } catch (Exception e) {
            return null;
        }
    }
}
```

### 2.6 用户数据访问层 (UserDAO)

**文件**: `src/main/java/com/insurance/dao/UserDAO.java`

**关键方法**:

- `getUserByUsername()` - 根据用户名获取用户
- `mapResultSetToUser()` - 将结果集映射到 User 对象

**核心代码**:

```java
public class UserDAO {
    public User getUserByUsername(String username) throws SQLException {
        String sql = "SELECT * FROM users WHERE username = ? AND deleted = false";

        try (Connection conn = DatabaseUtil.getConnection();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {

            pstmt.setString(1, username);

            try (ResultSet rs = pstmt.executeQuery()) {
                if (rs.next()) {
                    return mapResultSetToUser(rs);
                }
            }
        }
        return null;
    }

    private User mapResultSetToUser(ResultSet rs) throws SQLException {
        User user = new User();
        user.setId(rs.getInt("id"));
        user.setUsername(rs.getString("username"));
        user.setPassword(rs.getString("password"));
        user.setEmail(rs.getString("email"));
        user.setFullName(rs.getString("full_name"));
        user.setRole(rs.getString("role"));
        user.setActive(rs.getBoolean("active"));
        user.setCreatedAt(rs.getTimestamp("created_at"));
        user.setUpdatedAt(rs.getTimestamp("updated_at"));
        user.setLastLogin(rs.getTimestamp("last_login"));
        return user;
    }
}
```

### 2.7 用户模型层 (User)

**文件**: `src/main/java/com/insurance/model/User.java`

**关键字段**:

- id - 用户 ID
- username - 用户名
- password - 密码（加密存储）
- email - 邮箱
- fullName - 用户全名
- role - 用户角色（ADMIN/SALES/REVIEWER/USER）
- active - 账户是否激活
- createdAt - 创建时间
- updatedAt - 更新时间
- lastLogin - 最后登录时间

### 2.8 数据库层

**表名**: `users`

**关键字段**:

- id (主键)
- username (用户名)
- password (密码)
- email (邮箱)
- full_name (用户全名)
- role (用户角色)
- active (账户是否激活)
- created_at (创建时间)
- updated_at (更新时间)
- last_login (最后登录时间)
- login_attempts (登录失败次数)
- account_locked_until (账户锁定截止时间)

### 2.9 JSP 视图层

**文件**: `src/main/webapp/login.jsp`

**关键代码**:

```jsp
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>

<form method="post" action="${pageContext.request.contextPath}/login" class="login-form">
    <input type="hidden" name="csrfToken" value="${csrfToken}">

    <div class="form-group">
        <label for="username">用户名</label>
        <input type="text" id="username" name="username"
               class="form-control" required
               value="${username}"
               placeholder="请输入用户名">
    </div>

    <div class="form-group">
        <label for="password">密码</label>
        <div class="password-container">
            <input type="password" id="password" name="password"
                   class="form-control" required
                   placeholder="请输入密码">
        </div>
    </div>

    <div class="form-group">
        <button type="submit" class="btn btn-primary btn-block">登录</button>
    </div>
</form>

<c:if test="${not empty error}">
    <div class="alert alert-danger">
        ${error}
    </div>
</c:if>
```

## 3. 流程总结

1. **用户访问**: 用户访问登录页面`/login.jsp`
2. **表单提交**: 用户输入用户名和密码并提交登录表单
3. **CSRF 验证**: `AuthController`验证 CSRF 令牌防止跨站请求伪造
4. **参数验证**: 验证用户名和密码是否为空
5. **认证处理**: 调用`AuthUtil.authenticate()`进行用户认证
6. **密码验证**: 使用 SHA-256 加密算法验证密码
7. **数据库查询**: 通过`UserService`和`UserDAO`查询用户信息
8. **会话创建**: 认证成功后创建会话并存储用户信息
9. **权限检查**: `SecurityFilter`在每次请求时检查用户权限
10. **资源访问**: 根据用户角色重定向到相应页面并允许访问受保护资源

这个流程展示了完整的用户认证和授权机制，包括安全防护措施如 CSRF 令牌验证、会话管理、权限控制等。

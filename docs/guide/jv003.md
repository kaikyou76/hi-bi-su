# Java Servlet 顾客管理代码详解（带注释）

## 代码整体结构说明

这段代码是一个基于 Java Servlet 的顾客管理控制器，采用 MVC（Model-View-Controller）设计模式，负责处理与顾客相关的 HTTP 请求，并与 Service 层交互，最终将结果展示到 JSP 视图。

```java
// 包声明：指定该Servlet所属的包结构
package com.insurance.controller;

// 导入所需的类：
// 1. 模型类：Customer（顾客数据模型）
// 2. 服务类：CustomerService（处理顾客业务逻辑）
// 3. Servlet API：处理HTTP请求和响应
// 4. 日期处理类：用于日期格式转换
import com.insurance.model.Customer;
import com.insurance.service.CustomerService;
import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.annotation.WebServlet;
import java.io.IOException;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;

/**
 * 顾客管理Servlet
 * 注解@WebServlet("/customer")表示该Servlet处理所有以"/customer"开头的URL请求
 */
@WebServlet("/customer")
public class CustomerServlet extends HttpServlet {
    // 声明CustomerService对象，用于调用业务逻辑方法
    private CustomerService customerService;

    /**
     * Servlet初始化方法
     * 在Servlet实例创建后被调用一次，用于初始化资源
     */
    @Override
    public void init() throws ServletException {
        super.init();
        // 创建CustomerService实例，准备调用业务逻辑
        customerService = new CustomerService();
    }

    /**
     * 处理GET请求
     * 通常用于查询操作，如显示列表、查看详情、显示编辑表单等
     */
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // 从请求参数中获取"action"参数，用于判断用户要执行的操作
        String action = request.getParameter("action");
        // 如果没有指定action，默认执行"list"操作（显示顾客列表）
        if (action == null) {
            action = "list";
        }

        try {
            // 根据不同的action值，调用对应的方法
            switch (action) {
                case "list":       // 显示顾客列表
                    listCustomers(request, response);
                    break;
                case "view":       // 查看顾客详情
                    viewCustomer(request, response);
                    break;
                case "edit":       // 显示编辑表单
                    showEditForm(request, response);
                    break;
                case "delete":     // 删除顾客
                    deleteCustomer(request, response);
                    break;
                case "search":     // 搜索顾客
                    searchCustomers(request, response);
                    break;
                default:           // 默认显示顾客列表
                    listCustomers(request, response);
                    break;
            }
        } catch (Exception e) {
            // 捕获异常并包装成ServletException抛出
            throw new ServletException(e);
        }
    }

    /**
     * 处理POST请求
     * 通常用于修改数据的操作，如添加、更新顾客信息
     */
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // 获取action参数，判断要执行的操作
        String action = request.getParameter("action");
        // 如果没有指定action，重定向到顾客列表页面
        if (action == null) {
            response.sendRedirect("customer?action=list");
            return;
        }

        try {
            // 根据不同的action值，调用对应的方法
            switch (action) {
                case "add":        // 添加顾客
                    addCustomer(request, response);
                    break;
                case "update":     // 更新顾客
                    updateCustomer(request, response);
                    break;
                default:           // 默认重定向到顾客列表
                    response.sendRedirect("customer?action=list");
                    break;
            }
        } catch (Exception e) {
            throw new ServletException(e);
        }
    }

    /**
     * 显示顾客列表
     * 1. 从Service层获取所有顾客数据
     * 2. 将数据存储到request对象中，传递给JSP页面
     * 3. 转发到列表页面进行显示
     */
    private void listCustomers(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // 调用Service层方法获取所有顾客列表
        List<Customer> customers = customerService.getAllCustomers();
        // 将顾客列表存储到request作用域，键为"customers"，JSP页面可通过${customers}访问
        request.setAttribute("customers", customers);
        // 获取请求调度器，指定要转发的JSP页面路径
        RequestDispatcher dispatcher = request.getRequestDispatcher("/WEB-INF/views/customer/list.jsp");
        // 将请求和响应转发到JSP页面
        dispatcher.forward(request, response);
    }

    /**
     * 查看顾客详情
     * 1. 从请求参数获取顾客ID
     * 2. 根据ID查询顾客详情
     * 3. 将顾客信息传递给详情页面显示
     */
    private void viewCustomer(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // 获取请求参数中的"id"（顾客ID）
        String idStr = request.getParameter("id");
        // 检查ID是否为空或空字符串
        if (idStr == null || idStr.isEmpty()) {
            // 如果ID为空，重定向到顾客列表页面
            response.sendRedirect("customer?action=list");
            return;
        }

        try {
            // 将字符串ID转换为整数
            int id = Integer.parseInt(idStr);
            // 调用Service层方法根据ID查询顾客
            Customer customer = customerService.getCustomerById(id);

            // 检查顾客是否存在
            if (customer == null) {
                // 如果顾客不存在，设置错误消息并重定向到列表页面
                request.setAttribute("errorMessage", "顾客不存在");
                response.sendRedirect("customer?action=list");
                return;
            }

            // 将顾客对象存储到request作用域
            request.setAttribute("customer", customer);
            // 转发到详情页面
            RequestDispatcher dispatcher = request.getRequestDispatcher("/WEB-INF/views/customer/view.jsp");
            dispatcher.forward(request, response);
        } catch (NumberFormatException e) {
            // 如果ID不是有效的数字，设置错误消息并重定向
            request.setAttribute("errorMessage", "无效的顾客ID");
            response.sendRedirect("customer?action=list");
        }
    }

    /**
     * 显示编辑表单
     * 1. 如果有ID参数，查询顾客信息并显示在表单中（编辑模式）
     * 2. 如果没有ID参数，显示空表单（添加模式）
     */
    private void showEditForm(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // 获取ID参数
        String idStr = request.getParameter("id");

        // 如果ID不为空且不为空字符串
        if (idStr != null && !idStr.isEmpty()) {
            try {
                // 转换ID为整数
                int id = Integer.parseInt(idStr);
                // 查询顾客信息
                Customer customer = customerService.getCustomerById(id);

                // 如果顾客存在
                if (customer != null) {
                    // 将顾客信息和编辑标记存储到request作用域
                    request.setAttribute("customer", customer);
                    request.setAttribute("isEdit", true); // 用于JSP判断是否为编辑模式
                }
            } catch (NumberFormatException e) {
                // ID格式错误，忽略错误，显示空表单
            }
        }

        // 转发到表单页面
        RequestDispatcher dispatcher = request.getRequestDispatcher("/WEB-INF/views/customer/form.jsp");
        dispatcher.forward(request, response);
    }

    /**
     * 添加顾客
     * 1. 从请求参数创建Customer对象
     * 2. 验证顾客信息
     * 3. 调用Service层添加顾客
     * 4. 根据结果重定向或显示错误
     */
    private void addCustomer(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // 调用辅助方法从请求参数创建Customer对象
        Customer customer = createCustomerFromRequest(request);
        // 验证顾客信息，获取验证错误消息（如果有）
        String validationError = customerService.validateCustomer(customer);

        // 如果有验证错误
        if (validationError != null) {
            // 设置错误消息和顾客对象到request作用域
            request.setAttribute("errorMessage", validationError);
            request.setAttribute("customer", customer);
            // 转发回表单页面，显示错误信息
            RequestDispatcher dispatcher = request.getRequestDispatcher("/WEB-INF/views/customer/form.jsp");
            dispatcher.forward(request, response);
            return;
        }

        // 调用Service层方法添加顾客
        boolean success = customerService.addCustomer(customer);

        if (success) {
            // 添加成功，重定向到顾客列表，并附带成功消息
            response.sendRedirect("customer?action=list&message=顾客添加成功");
        } else {
            // 添加失败，设置错误消息并返回表单页面
            request.setAttribute("errorMessage", "添加顾客失败，请检查顾客编号是否重复");
            request.setAttribute("customer", customer);
            RequestDispatcher dispatcher = request.getRequestDispatcher("/WEB-INF/views/customer/form.jsp");
            dispatcher.forward(request, response);
        }
    }

    /**
     * 更新顾客
     * 1. 获取顾客ID和更新信息
     * 2. 验证信息并调用Service层更新
     * 3. 根据结果重定向或显示错误
     */
    private void updateCustomer(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // 获取顾客ID
        String idStr = request.getParameter("id");
        // 检查ID是否为空
        if (idStr == null || idStr.isEmpty()) {
            response.sendRedirect("customer?action=list");
            return;
        }

        try {
            // 转换ID为整数
            int id = Integer.parseInt(idStr);
            // 从请求参数创建Customer对象
            Customer customer = createCustomerFromRequest(request);
            // 设置顾客ID（因为表单可能不包含ID字段）
            customer.setId(id);

            // 验证顾客信息
            String validationError = customerService.validateCustomer(customer);
            if (validationError != null) {
                // 验证失败，返回表单并显示错误
                request.setAttribute("errorMessage", validationError);
                request.setAttribute("customer", customer);
                request.setAttribute("isEdit", true); // 标记为编辑模式
                RequestDispatcher dispatcher = request.getRequestDispatcher("/WEB-INF/views/customer/form.jsp");
                dispatcher.forward(request, response);
                return;
            }

            // 调用Service层方法更新顾客
            boolean success = customerService.updateCustomer(customer);

            if (success) {
                // 更新成功，重定向到列表页面
                response.sendRedirect("customer?action=list&message=顾客更新成功");
            } else {
                // 更新失败，返回表单
                request.setAttribute("errorMessage", "更新顾客失败");
                request.setAttribute("customer", customer);
                request.setAttribute("isEdit", true);
                RequestDispatcher dispatcher = request.getRequestDispatcher("/WEB-INF/views/customer/form.jsp");
                dispatcher.forward(request, response);
            }
        } catch (NumberFormatException e) {
            // ID格式错误
            request.setAttribute("errorMessage", "无效的顾客ID");
            response.sendRedirect("customer?action=list");
        }
    }

    /**
     * 删除顾客
     * 1. 获取顾客ID
     * 2. 调用Service层删除顾客
     * 3. 重定向到列表页面
     */
    private void deleteCustomer(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // 获取顾客ID
        String idStr = request.getParameter("id");
        // 检查ID是否为空
        if (idStr == null || idStr.isEmpty()) {
            response.sendRedirect("customer?action=list");
            return;
        }

        try {
            // 转换ID为整数
            int id = Integer.parseInt(idStr);
            // 调用Service层方法删除顾客
            boolean success = customerService.deleteCustomer(id);

            if (success) {
                // 删除成功，重定向到列表页面并显示成功消息
                response.sendRedirect("customer?action=list&message=顾客删除成功");
            } else {
                // 删除失败，重定向到列表页面并显示错误消息
                response.sendRedirect("customer?action=list&error=删除顾客失败");
            }
        } catch (NumberFormatException e) {
            // ID格式错误
            response.sendRedirect("customer?action=list&error=无效的顾客ID");
        }
    }

    /**
     * 搜索顾客
     * 1. 获取搜索关键词
     * 2. 调用Service层搜索顾客
     * 3. 显示搜索结果
     */
    private void searchCustomers(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // 获取搜索关键词
        String keyword = request.getParameter("keyword");
        // 调用Service层方法搜索顾客
        List<Customer> customers = customerService.searchCustomers(keyword);
        // 将搜索结果和关键词存储到request作用域
        request.setAttribute("customers", customers);
        request.setAttribute("searchKeyword", keyword);
        // 转发到列表页面显示搜索结果
        RequestDispatcher dispatcher = request.getRequestDispatcher("/WEB-INF/views/customer/list.jsp");
        dispatcher.forward(request, response);
    }

    /**
     * 辅助方法：从请求参数创建Customer对象
     * 将HTTP请求中的表单参数提取并设置到Customer对象中
     */
    private Customer createCustomerFromRequest(HttpServletRequest request) {
        // 创建新的Customer对象
        Customer customer = new Customer();

        // 设置基本属性（直接从请求参数获取字符串值）
        customer.setCustomerCode(request.getParameter("customerCode"));
        customer.setFirstName(request.getParameter("firstName"));
        customer.setLastName(request.getParameter("lastName"));
        customer.setFirstNameKana(request.getParameter("firstNameKana"));
        customer.setLastNameKana(request.getParameter("lastNameKana"));
        customer.setGender(request.getParameter("gender"));

        // 处理出生日期（需要格式转换）
        String birthDateStr = request.getParameter("birthDate");
        if (birthDateStr != null && !birthDateStr.isEmpty()) {
            try {
                // 创建日期格式化对象，指定输入格式为"yyyy-MM-dd"
                SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
                // 将字符串转换为Date对象
                Date birthDate = sdf.parse(birthDateStr);
                // 设置出生日期
                customer.setBirthDate(birthDate);
            } catch (ParseException e) {
                // 日期格式错误，不设置值，将在验证时处理
            }
        }

        // 设置地址相关属性
        customer.setPostalCode(request.getParameter("postalCode"));
        customer.setPrefecture(request.getParameter("prefecture"));
        customer.setCity(request.getParameter("city"));
        customer.setAddressLine1(request.getParameter("addressLine1"));
        customer.setAddressLine2(request.getParameter("addressLine2"));

        // 设置联系信息
        customer.setPhoneNumber(request.getParameter("phoneNumber"));
        customer.setEmail(request.getParameter("email"));

        // 设置职业
        customer.setOccupation(request.getParameter("occupation"));

        // 处理年收入（需要转换为数字）
        String annualIncomeStr = request.getParameter("annualIncome");
        if (annualIncomeStr != null && !annualIncomeStr.isEmpty()) {
            try {
                // 将字符串转换为double类型
                double annualIncome = Double.parseDouble(annualIncomeStr);
                // 设置年收入
                customer.setAnnualIncome(annualIncome);
            } catch (NumberFormatException e) {
                // 数字格式错误，不设置值
            }
        }

        // 设置家庭构成
        customer.setFamilyComposition(request.getParameter("familyComposition"));

        // 返回创建好的Customer对象
        return customer;
    }
}
```

## 核心知识点总结

### 1. Servlet 基础

- **Servlet 是什么**：运行在 Web 服务器上的 Java 程序，用于处理客户端请求并生成响应
- **@WebServlet 注解**：用于配置 Servlet 的访问路径，如`@WebServlet("/customer")`表示所有`/customer`开头的请求由该 Servlet 处理
- **生命周期方法**：`init()`（初始化）、`doGet()`/`doPost()`（处理请求）、`destroy()`（销毁）

### 2. HTTP 请求处理

- **GET vs POST**：
  - GET：用于查询操作，参数在 URL 中可见，有长度限制
  - POST：用于修改数据操作，参数在请求体中，更安全，无长度限制
- **请求参数获取**：`request.getParameter("参数名")`
- **请求转发与重定向**：
  - 转发（forward）：服务器内部跳转，地址栏不变，共享 request 作用域
  - 重定向（redirect）：客户端跳转，地址栏改变，不共享 request 作用域

### 3. MVC 设计模式应用

- **Model（模型）**：`Customer`类（数据模型）、`CustomerService`类（业务逻辑）
- **View（视图）**：JSP 页面（`list.jsp`、`view.jsp`、`form.jsp`）
- **Controller（控制器）**：`CustomerServlet`类（处理请求、协调模型和视图）

### 4. 数据流转

1. 客户端发送 HTTP 请求到 Servlet
2. Servlet 解析请求参数，调用 Service 层处理业务逻辑
3. Service 层返回数据给 Servlet
4. Servlet 将数据存入 request 作用域，转发到 JSP 页面
5. JSP 页面渲染数据并生成 HTML 响应给客户端

### 5. 错误处理

- 参数验证：在添加/更新顾客前进行数据验证
- 异常捕获：使用 try-catch 处理可能的异常（如数字转换异常、日期格式异常）
- 用户反馈：通过 request 作用域传递错误消息，或在 URL 中附带消息参数
